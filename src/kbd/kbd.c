/*
 *                          Copyright (C) 2016, 2017 by Rafael Santiago
 *
 * This is a free software. You can redistribute it and/or modify under
 * the terms of the GNU General Public License version 2.
 *
 */

#include <kbd/kbd.h>
#include <vid/vid.h>
#include <accacia.h>
#include <ctype.h>
#include <string.h>
#include <pthread.h>

static int g_kbd_tcolor = AC_BCOLOR_WHITE;

static int g_kbd_bcolor = AC_BCOLOR_BLACK;

static int g_kbd_pcolor = AC_BCOLOR_CYAN;

static int g_kbd_lkey = 0;

static int g_cp8_kpad[0xf] = { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 };

#ifndef NO_PTHREAD_SUPPORT

static int g_ttr = 0;

static pthread_mutex_t g_cp8_kpad_mtx = PTHREAD_MUTEX_INITIALIZER;

static void *cp8_kbdloop(void *args);

static void cp8_kbdread(void);

#else

void cp8_kbdrelease(void);

#endif

#define CP8_KBD_X 68

#define CP8_KBD_Y 1

#define CP8_KBD_XPAD 2

#define CP8_KBD_YPAD 1

// INFO(Rafael): The following craziness is related with all pixel maps for the retro 8-bit keys stuff.

static cp8_blitchar_pxmap_t g_kbd_k0 = {
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x0f, 0xff, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x0f, 0xff, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff }
};

static cp8_blitchar_pxmap_t g_kbd_k1 = {
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0xff, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0xff, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0xff, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0xff, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0xff, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0xff, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff }
};

static cp8_blitchar_pxmap_t g_kbd_k2 = {
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff }
};

static cp8_blitchar_pxmap_t g_kbd_k3 = {
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff }
};

static cp8_blitchar_pxmap_t g_kbd_k4 = {
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff }
};

static cp8_blitchar_pxmap_t g_kbd_k5 = {
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff }
};

static cp8_blitchar_pxmap_t g_kbd_k6 = {
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff }
};

static cp8_blitchar_pxmap_t g_kbd_k7 = {
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff }
};

static cp8_blitchar_pxmap_t g_kbd_k8 = {
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff }
};

static cp8_blitchar_pxmap_t g_kbd_k9 = {
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff }
};

static cp8_blitchar_pxmap_t g_kbd_ka = {
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff }
};

static cp8_blitchar_pxmap_t g_kbd_kb = {
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0xf0, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0xf0, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff }
};

static cp8_blitchar_pxmap_t g_kbd_kc = {
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff }
};

static cp8_blitchar_pxmap_t g_kbd_kd = {
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0xf0, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0xf0, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0xf0, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0xf0, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff }
};

static cp8_blitchar_pxmap_t g_kbd_ke = {
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff }
};

static cp8_blitchar_pxmap_t g_kbd_kf = {
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0xff, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff },
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff }
};

// WARN(Rafael): Boring code and kind of stupid do not waste your time reading it..

static void cp8_kbdkdraw(const unsigned char k, const int kcolor);

struct cp8_kbd_key_ctx {
    cp8_blitchar_pxmap_t *key;
    const int x, y;
};

static unsigned char kval(const unsigned char k) {
    unsigned char v = toupper(k);
    switch (v) {

        case '0':
        case '1':
        case '2':
        case '3':
        case '4':
        case '5':
        case '6':
        case '7':
        case '8':
        case '9':
            v = v - '0';
            break;

        case 'A':
        case 'B':
        case 'C':
        case 'D':
        case 'E':
        case 'F':
            v = v - 55;
            break;

    }

    return v;
}

unsigned char cp8_kbdhit(void) {
    unsigned char retval = 0xff;
    size_t k;

#ifndef NO_PTHREAD_SUPPORT
    pthread_mutex_lock(&g_cp8_kpad_mtx);
#endif

    for (k = 0; k < 0xf && retval == 0xff; k++) {
        if (g_cp8_kpad[k] == 1) {
            retval = k;
        }
    }

#ifndef NO_PTHREAD_SUPPORT
    pthread_mutex_unlock(&g_cp8_kpad_mtx);
#endif

    return retval;
}

#ifdef NO_PTHREAD_SUPPORT

void cp8_kbdrelease(void) {
    memset(g_cp8_kpad, 0, sizeof(g_cp8_kpad));
}

#endif

#ifndef NO_PTHREAD_SUPPORT

static void cp8_kbdread(void) {

#else

void cp8_kbdread(void) {

#endif
    unsigned char key = 0xff;

    accacia_savecursorposition();

    if (accacia_kbhit()) {
        g_kbd_lkey = accacia_getch();
        key = kval(g_kbd_lkey);
    }

    if (key >= 0x0 && key <= 0xf) {
#ifndef NO_PTHREAD_SUPPORT
        pthread_mutex_lock(&g_cp8_kpad_mtx);
#endif
        memset(g_cp8_kpad, 0, sizeof(g_cp8_kpad));
        g_cp8_kpad[key] = 1;
#ifndef NO_PTHREAD_SUPPORT
        g_ttr = 100;
        pthread_mutex_unlock(&g_cp8_kpad_mtx);
#endif
    }

    accacia_restorecursorposition();
}

unsigned char cp8_kbdlkey(void) {
    return g_kbd_lkey;
}

static void cp8_kbdkdraw(const unsigned char k, const int kcolor) {
    // WARN(Rafael): Good luck with this awful look...

    switch (tolower(k)) {
        // CLUE(Rafael): Line 1
        case '1':
            cp8_vidblitchar(CP8_KBD_X, CP8_KBD_Y, g_kbd_k1, kcolor, g_kbd_bcolor);
            break;

        case '2':
            cp8_vidblitchar(CP8_KBD_X + CP8_BLITCHAR_MW + CP8_KBD_XPAD, CP8_KBD_Y, g_kbd_k2, kcolor, g_kbd_bcolor);
            break;

        case '3':
            cp8_vidblitchar(CP8_KBD_X + (2 * (CP8_BLITCHAR_MW + CP8_KBD_XPAD)), CP8_KBD_Y, g_kbd_k3, kcolor, g_kbd_bcolor);
            break;

        case 'c':
            cp8_vidblitchar(CP8_KBD_X + (3 * (CP8_BLITCHAR_MW + CP8_KBD_XPAD)), CP8_KBD_Y, g_kbd_kc, kcolor, g_kbd_bcolor);
            break;

        // CLUE(Rafael): Line 2
        case '4':
            cp8_vidblitchar(CP8_KBD_X, CP8_KBD_Y + CP8_BLITCHAR_MH + CP8_KBD_YPAD, g_kbd_k4, kcolor, g_kbd_bcolor);
            break;

        case '5':
            cp8_vidblitchar(CP8_KBD_X + CP8_BLITCHAR_MW + CP8_KBD_XPAD, CP8_KBD_Y + CP8_BLITCHAR_MH + CP8_KBD_YPAD, g_kbd_k5, kcolor, g_kbd_bcolor);
            break;

        case '6':
            cp8_vidblitchar(CP8_KBD_X + (2 * (CP8_BLITCHAR_MW + CP8_KBD_XPAD)), CP8_KBD_Y + CP8_BLITCHAR_MH + CP8_KBD_YPAD, g_kbd_k6, kcolor, g_kbd_bcolor);
            break;

        case 'd':
            cp8_vidblitchar(CP8_KBD_X + (3 * (CP8_BLITCHAR_MW + CP8_KBD_XPAD)), CP8_KBD_Y + CP8_BLITCHAR_MH + CP8_KBD_YPAD, g_kbd_kd, kcolor, g_kbd_bcolor);
            break;

        // CLUE(Rafael): Line 3
        case '7':
            cp8_vidblitchar(CP8_KBD_X, CP8_KBD_Y + (2 * (CP8_BLITCHAR_MH + CP8_KBD_YPAD)), g_kbd_k7, kcolor, g_kbd_bcolor);
            break;

        case '8':
            cp8_vidblitchar(CP8_KBD_X + CP8_BLITCHAR_MW + CP8_KBD_XPAD, CP8_KBD_Y + (2 * (CP8_BLITCHAR_MH + CP8_KBD_YPAD)), g_kbd_k8, kcolor, g_kbd_bcolor);
            break;

        case '9':
            cp8_vidblitchar(CP8_KBD_X + (2 * (CP8_BLITCHAR_MW + CP8_KBD_XPAD)), CP8_KBD_Y + (2 * (CP8_BLITCHAR_MH + CP8_KBD_YPAD)), g_kbd_k9, kcolor, g_kbd_bcolor);
            break;

        case 'e':
            cp8_vidblitchar(CP8_KBD_X + (3 * (CP8_BLITCHAR_MW + CP8_KBD_XPAD)), CP8_KBD_Y + (2 * (CP8_BLITCHAR_MH + CP8_KBD_YPAD)), g_kbd_ke, kcolor, g_kbd_bcolor);
            break;

        // CLUE(Rafael): Line 4
        case 'a':
            cp8_vidblitchar(CP8_KBD_X, CP8_KBD_Y + (3 * (CP8_BLITCHAR_MH + CP8_KBD_YPAD)), g_kbd_ka, kcolor, g_kbd_bcolor);
            break;

        case '0':
            cp8_vidblitchar(CP8_KBD_X + CP8_BLITCHAR_MW + CP8_KBD_XPAD, CP8_KBD_Y + (3 * (CP8_BLITCHAR_MH + CP8_KBD_YPAD)), g_kbd_k0, kcolor, g_kbd_bcolor);
            break;

        case 'b':
            cp8_vidblitchar(CP8_KBD_X + (2 * (CP8_BLITCHAR_MW + CP8_KBD_XPAD)), CP8_KBD_Y + (3 * (CP8_BLITCHAR_MH + CP8_KBD_YPAD)), g_kbd_kb, kcolor, g_kbd_bcolor);
            break;

        case 'f':
            cp8_vidblitchar(CP8_KBD_X + (3 * (CP8_BLITCHAR_MW + CP8_KBD_XPAD)), CP8_KBD_Y + (3 * (CP8_BLITCHAR_MH + CP8_KBD_YPAD)), g_kbd_kf, kcolor, g_kbd_bcolor);
            break;

    }

    accacia_gotoxy(1, 1);
}

void cp8_kbdinit(void) {
#ifndef NO_PTHREAD_SUPPORT
    pthread_t kbd;
    pthread_attr_t kbdattr;
    pthread_mutexattr_t attr;

    pthread_mutexattr_init(&attr);
    pthread_mutexattr_settype(&attr, PTHREAD_MUTEX_RECURSIVE);
    pthread_mutex_init(&g_cp8_kpad_mtx, &attr);
#endif

    cp8_kbdkdraw('1', g_kbd_tcolor);
    cp8_kbdkdraw('2', g_kbd_tcolor);
    cp8_kbdkdraw('3', g_kbd_tcolor);
    cp8_kbdkdraw('c', g_kbd_tcolor);
    cp8_kbdkdraw('4', g_kbd_tcolor);
    cp8_kbdkdraw('5', g_kbd_tcolor);
    cp8_kbdkdraw('6', g_kbd_tcolor);
    cp8_kbdkdraw('d', g_kbd_tcolor);
    cp8_kbdkdraw('7', g_kbd_tcolor);
    cp8_kbdkdraw('8', g_kbd_tcolor);
    cp8_kbdkdraw('9', g_kbd_tcolor);
    cp8_kbdkdraw('e', g_kbd_tcolor);
    cp8_kbdkdraw('a', g_kbd_tcolor);
    cp8_kbdkdraw('0', g_kbd_tcolor);
    cp8_kbdkdraw('b', g_kbd_tcolor);
    cp8_kbdkdraw('f', g_kbd_tcolor);

#ifndef NO_PTHREAD_SUPPORT
    pthread_attr_init(&kbdattr);
    pthread_create(&kbd, &kbdattr, cp8_kbdloop, NULL);
#endif
}


#ifndef NO_PTHREAD_SUPPORT

static void *cp8_kbdloop(void *args) {
    while (g_kbd_lkey != 27) {
        cp8_kbdread();
        usleep(1);
        pthread_mutex_lock(&g_cp8_kpad_mtx);
        if (g_ttr == 0) {
            memset(g_cp8_kpad, 0, sizeof(g_cp8_kpad));
        } else {
            g_ttr--;
        }
        pthread_mutex_unlock(&g_cp8_kpad_mtx);
    }

    return NULL;
}

#endif